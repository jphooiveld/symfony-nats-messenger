name: CI

on:
  push:
    branches: [ main, road_to_stable, docker_refactor ]
  pull_request:
    branches: [ main, road_to_stable ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Set explicit timeout for the entire job

    strategy:
      matrix:
        php-version: [8.2, 8.3, 8.4]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: igbinary, json, mbstring, simdjson
        coverage: xdebug
        tools: composer:v2

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bc netcat-openbsd

    # - name: Get composer cache directory
    #   id: composer-cache
    #   run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    # - name: Cache dependencies
    #   uses: actions/cache@v3
    #   with:
    #     path: ${{ steps.composer-cache.outputs.dir }}
    #     key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
    #     restore-keys: ${{ runner.os }}-composer-

    - name: Start docker container
      run: make run-nats

    - name: Install dependencies
      run: make setup-unit-tests

    - name: Run unit tests with coverage
      run: make run-unit-tests

    - name: Check coverage threshold (90%)
      run: |
        # Extract coverage percentage from clover.xml
        COVERAGE=$(php -r "
          \$xml = simplexml_load_file('clover.xml');
          \$projectMetrics = \$xml->project->metrics;
          \$statements = (int)\$projectMetrics['statements'];
          \$coveredStatements = (int)\$projectMetrics['coveredstatements'];
          if (\$statements > 0) {
            \$percentage = (\$coveredStatements / \$statements) * 100;
            echo number_format(\$percentage, 2);
          } else {
            echo '0';
          }
        ")

        echo "Coverage: ${COVERAGE}%"
        echo "Covered statements: $(php -r "\$xml = simplexml_load_file('clover.xml'); echo \$xml->project->metrics['coveredstatements'];")"
        echo "Total statements: $(php -r "\$xml = simplexml_load_file('clover.xml'); echo \$xml->project->metrics['statements'];")"

        # Check if coverage meets minimum threshold
        THRESHOLD=90.00
        if (( $(echo "${COVERAGE} >= ${THRESHOLD}" | bc -l) )); then
          echo "✅ Coverage ${COVERAGE}% meets minimum threshold of ${THRESHOLD}%"
        else
          echo "❌ Coverage ${COVERAGE}% is below minimum threshold of ${THRESHOLD}%"
          exit 1
        fi

    - name: Install functional test dependencies
      run: |
        make setup-functional-tests

    - name: Run functional tests
      timeout-minutes: 10  # Set explicit timeout for functional tests
      run: |
        make run-functional-tests

    - name: Run benchmark tests
      timeout-minutes: 5  # Set explicit timeout for benchmark tests
      env:
        APP_ENV: test
        NATS_DSN: nats://localhost:4222
      run: |
        cd tests/functional
        chmod +x run-benchmark.sh
        # Run benchmark with a smaller message count for CI
        ./run-benchmark.sh --count 1000
      continue-on-error: true  # Don't fail the entire workflow if benchmark fails

    - name: Collect logs on failure
      if: failure()
      run: |
        echo "=== NATS Container Logs ==="
        docker logs nats_test || echo "Could not get NATS logs"
        echo "=== Docker Containers ==="
        docker ps -a
        echo "=== Network Status ==="
        netstat -tlnp | grep :4222 || echo "Port 4222 not listening"

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: matrix.php-version == '8.4'
      with:
        name: coverage-report
        path: |
          clover.xml
          coverage/
        retention-days: 5

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: matrix.php-version == '8.4'
      with:
        name: benchmark-results
        path: tests/functional/benchmark-*.txt
        retention-days: 5

    - name: Stop NATS server
      if: always()
      run: |
        make stop-nats